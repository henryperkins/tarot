{
  // ============================================================================
  // Cloudflare Workers Configuration - Tableau (Mystic Tarot)
  // ============================================================================
  // Migrated from Pages to Workers for full Logpush support
  // Ref: https://developers.cloudflare.com/workers/wrangler/configuration/
  "name": "tableau",
  // TODO: Add your Cloudflare account ID here (required for Workers deploy)
  // Find it at: https://dash.cloudflare.com/ → select your account → copy from URL
  "account_id": "a77e479f6736120eadd99973dbeb705e",
  "compatibility_date": "2025-11-24",
  "compatibility_flags": [
    "nodejs_compat"
  ],
  // Routes - custom domain configuration
  "routes": [
    {
      "pattern": "tarot.lakefrontdev.com",
      "zone_name": "lakefrontdev.com",
      "custom_domain": true
    }
  ],
  // Main worker entry point (unified router)
  "main": "./src/worker/index.js",
  // Static assets configuration (SPA fallback enabled)
  "assets": {
    "directory": "./dist",
    "binding": "ASSETS",
    "not_found_handling": "single-page-application"
  },
  // Workers AI binding for evaluation
  "ai": {
    "binding": "AI"
  },
  // Enable Logpush for Workers trace events
  "logpush": true,
  // Observability
  "observability": {
    "enabled": true
  },
  "tail_consumers": [
    {
      "service": "azure-search-mcp-tail"
    }
  ],
  // ============================================================================
  // Environment Variables (Non-Secret)
  // ============================================================================
  "vars": {
    "ENABLE_SEMANTIC_SCORING": "true",
    "AZURE_OPENAI_GPT_AUDIO_MINI_FORMAT": "mp3",
    "AZURE_OPENAI_USE_V1_FORMAT": "true",
    "AZURE_OPENAI_API_VERSION": "preview",
    "AZURE_OPENAI_RESPONSES_API_VERSION": "v1",
    // Optional: override the api-version used for /openai/v1/responses TTS calls.
    // If unset/empty, falls back to AZURE_OPENAI_RESPONSES_API_VERSION (then AZURE_OPENAI_API_VERSION).
    "AZURE_OPENAI_TTS_RESPONSES_API_VERSION": "",
    "AZURE_OPENAI_STREAMING_ENABLED": "true",
    "ALLOW_STREAMING_WITH_EVAL_GATE": "true",
    "STREAMING_QUALITY_GATE_ENABLED": "true",
    "EVAL_ENABLED": "true",
    "EVAL_MODEL": "@cf/qwen/qwen3-30b-a3b-fp8",
    "EVAL_TIMEOUT_MS": "10000",
    // EVAL_GATE_ENABLED: When "true", readings that fail quality evaluation are
    // replaced with a safe fallback. CAUTION: If eval model is unavailable,
    // ALL readings will show fallback. Set to "false" for production safety.
    "EVAL_GATE_ENABLED": "false",
    // EVAL_GATE_FAILURE_MODE: "open" or "closed" (legacy *_FAIL_* vars deprecated)
    "EVAL_GATE_FAILURE_MODE": "closed",
    "EVAL_GATEWAY_ID": "",
    // METRICS_STORAGE_MODE controls PII handling in stored metrics:
    // - "redact" (default): Redact PII patterns from stored data
    // - "minimal": Store only aggregate metrics, no user content
    // - "full": Store complete data (DEVELOPMENT ONLY - contains PII)
    "METRICS_STORAGE_MODE": "redact",
    // -------------------------------------------------------------------------
    // Diagnostics & Logging
    // WARNING: LOG_LLM_PROMPTS and PERSIST_PROMPTS capture user questions and
    // personalization data. Enable only for debugging, disable in production.
    // -------------------------------------------------------------------------
    "LOG_LLM_PROMPTS": "true",
    "LOG_NARRATIVE_ENHANCEMENTS": "true",
    "LOG_ENHANCEMENT_TELEMETRY": "true",
    "PERSIST_PROMPTS": "true",
    "ENABLE_TTS_DEBUG_LOGGING": "false",
    "ENABLE_SPEECH_TOKEN_DEBUG": "false",
    // -------------------------------------------------------------------------
    // Vision validation backend settings (server-side only; UI still pins clip-default)
    // -------------------------------------------------------------------------
    "VISION_TIMEOUT_MS": "12000",
    "VISION_BACKEND_DEFAULT": "clip-default",
    // -------------------------------------------------------------------------
    // Quality Alerting & A/B Testing
    // -------------------------------------------------------------------------
    // QUALITY_ALERT_ENABLED: Enable automatic quality regression detection
    "QUALITY_ALERT_ENABLED": "true",
    // QUALITY_REGRESSION_THRESHOLD: Score drop to trigger warning (default: -0.3)
    "QUALITY_REGRESSION_THRESHOLD": "-0.3",
    // QUALITY_SAFETY_SPIKE_THRESHOLD: Safety flag rate to trigger alert (default: 0.02)
    "QUALITY_SAFETY_SPIKE_THRESHOLD": "0.02",
    // QUALITY_ALERT_MIN_READINGS: Minimum readings required to trigger alerting (default: 20)
    "QUALITY_ALERT_MIN_READINGS": "20",
    // ALERT_EMAIL_FROM: Sender email for quality alerts
    "ALERT_EMAIL_FROM": "alerts@tarot.app",
    // ALERT_EMAIL_TO: Recipient email for quality alerts (set via secret for production)
    "ALERT_EMAIL_TO": "",
    // AB_TESTING_ENABLED: Enable A/B testing variant assignment
    "AB_TESTING_ENABLED": "false",
    // -------------------------------------------------------------------------
    // Follow-up Questions Feature Flags
    // -------------------------------------------------------------------------
    "FEATURE_FOLLOW_UP_ENABLED": "true",
    "FEATURE_FOLLOW_UP_JOURNAL_CONTEXT": "true"
    // -------------------------------------------------------------------------
    // Prompt Budget & GraphRAG Settings (not set = use defaults)
    // -------------------------------------------------------------------------
    // ENABLE_PROMPT_SLIMMING: "false" (default) - When "true", enables token
    //   budget slimming that progressively drops prompt sections when over budget.
    //   Disabled because modern LLMs have large context windows and slimming
    //   removes valuable interpretive context.
    //
    // DISABLE_QUALITY_FILTERING: "false" (default) - When "true", disables
    //   GraphRAG passage relevance scoring. Passages are returned unfiltered.
    //   These two features are independent.
  },
  // ============================================================================
  // D1 Database
  // ============================================================================
  "d1_databases": [
    {
      "binding": "DB",
      "database_id": "ede622bd-5845-4da9-9031-839cb26ae7be",
      "database_name": "mystic-tarot-db"
    }
  ],
  // ============================================================================
  // KV Namespaces
  // ============================================================================
  "kv_namespaces": [
    {
      "binding": "RATELIMIT",
      "id": "893bd9a5206d4719817c6c5dc0f1a409",
      "preview_id": "785db8a0b1824eb092b2a9107f9e48f3"
    },
    {
      "binding": "FEEDBACK_KV",
      "id": "ff4fb140d62a44e9bb4f5af0630bb154",
      "preview_id": "ead919e83f114ec0abd0ac1592d3e9d3"
    },
    {
      "binding": "METRICS_DB",
      "id": "2510ac5ac91e4a2fac375190a3dfc128",
      "preview_id": "8e820de09f9c459ea0e149bf55644c81"
    }
  ],
  // ============================================================================
  // Durable Objects
  // ============================================================================
  "durable_objects": {
    "bindings": [
      {
        "name": "READING_JOBS",
        "class_name": "ReadingJob"
      }
    ]
  },
  "migrations": [
    {
      "tag": "reading-jobs-v1",
      "new_sqlite_classes": [
        "ReadingJob"
      ]
    }
  ],
  // ============================================================================
  // R2 Buckets
  // ============================================================================
  "r2_buckets": [
    {
      "binding": "R2_LOGS",
      "bucket_name": "tarot-logs"
    }
  ],
  // ============================================================================
  // Cron Triggers (Scheduled Tasks)
  // ============================================================================
  // Archive metrics/feedback from KV to D1 and cleanup expired sessions
  "triggers": {
    "crons": [
      "0 3 * * *"
    ]
  }
  // ============================================================================
  // Secrets (set via CLI, not in config)
  // ============================================================================
  // Azure OpenAI (GPT-5 narrative generation)
  // wrangler secret put AZURE_OPENAI_ENDPOINT
  // wrangler secret put AZURE_OPENAI_API_KEY
  // wrangler secret put AZURE_OPENAI_GPT5_MODEL
  //
  // Azure AI Foundry Anthropic (Claude fallback)
  // wrangler secret put AZURE_ANTHROPIC_ENDPOINT  (e.g., https://<resource>.services.ai.azure.com/anthropic)
  // wrangler secret put AZURE_ANTHROPIC_API_KEY   (from Foundry Keys & endpoint, or falls back to AZURE_OPENAI_API_KEY)
  // wrangler secret put AZURE_ANTHROPIC_MODEL     (deployment name, default: claude-opus-4-5)
  //
  // Azure TTS
  // wrangler secret put AZURE_OPENAI_TTS_ENDPOINT
  // wrangler secret put AZURE_OPENAI_TTS_API_KEY
  // wrangler secret put AZURE_OPENAI_GPT_AUDIO_MINI_DEPLOYMENT
  //
  // Azure Speech SDK (client-side token auth)
  // wrangler secret put AZURE_SPEECH_KEY
  // wrangler secret put AZURE_SPEECH_REGION  (optional, defaults to eastus2)
  //
  // Other
  // wrangler secret put VISION_PROOF_SECRET
  //
  // Admin (for manual archival trigger)
  // wrangler secret put ADMIN_API_KEY
}
